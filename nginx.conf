server {
    listen 80;
    server_name localhost;

    root /usr/share/nginx/html;
    index index.html;

    # Handle 404 errors
    error_page 404 /404.html;

    # --- SECURITY HEADERS START ---
    # Se definen variables o se repiten porque Nginx no hereda headers si un bloque location tiene sus propios add_header.
    
    # 1. HSTS (Crucial para Lighthouse): Fuerza HTTPS por 2 años.
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    
    # 2. CSP (Anti XSS): Mejorado para Lighthouse y Astro ViewTransitions.
    # - connect-src 'self': Necesario para Astro ClientRouter (prefetch/navigation).
    # - frame-ancestors 'none': Reemplazo moderno de X-Frame-Options.
    # - form-action 'self': Seguridad en formularios.
    # - Eliminado 'unsafe-eval': React en producción no debería necesitarlo.
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self'; object-src 'none'; base-uri 'self'; frame-ancestors 'none'; form-action 'self'; upgrade-insecure-requests;" always;
    
    # 3. Otros headers de seguridad
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # 4. COOP (Aislamiento de procesos - Requerido por Lighthouse moderno)
    add_header Cross-Origin-Opener-Policy "same-origin" always;
    # --- SECURITY HEADERS END ---

    location / {
        try_files $uri $uri/index.html =404;
        # Hereda los headers de arriba porque este bloque no tiene 'add_header' propios.
    }

    # Cache control for static assets
    location ~* \.(?:ico|css|js|gif|jpe?g|png|woff2?|svg)$ {
        expires 6M;
        access_log off;
        add_header Cache-Control "public";
        
        # IMPORTANTE: Al haber puesto un add_header aquí, Nginx ignora los del bloque server.
        # Debemos repetir los críticos para seguridad (HSTS y CSP) si queremos 100% de pureza, 
        # aunque para Lighthouse lo vital es que estén en el HTML (location /).
        
        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
        add_header X-Content-Type-Options "nosniff" always;
    }
}